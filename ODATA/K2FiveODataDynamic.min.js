function e(e,t){const a=e[t];return null==a?"":String(a)}function t(e,t){const a=e[t];return null==a||""===a?null:String(a)}function a(e,t){const a=e[t];if(null==a||""===a)return null;const r=Number(a);return isNaN(r)?null:r}function r(a,r,n){return new Promise(((o,u)=>{const l=s(e(r,"BaseUrl")),p=e(a,"SmartObjectName"),c=e(a,"AggregateField"),g=t(a,"Filter"),m=e(a,"AggregateAlias")||`${n}Result`;if(!p||!c)return void u(new Error("SmartObjectName and AggregateField are required."));const d=`aggregate(${c} with ${n} as ${m})`;let y=`${l}/${encodeURIComponent(p)}?$apply=`;g&&(y+=`filter(${encodeURIComponent(g)})/`),y+=encodeURIComponent(d),i(y,r,((e,t,a)=>{if(e)u(e);else try{const e=t.value||[t],a=e[0]?e[0][m]:null;postResult({SmartObjectName:p,AggregateField:c,AggregateValue:a,ResultJson:JSON.stringify(e)}),o()}catch(e){u(new Error(`Failed to process aggregate response: ${e}`))}}))}))}function s(e){return e?e.replace(/\/+$/,""):""}function n(e){const r=[],s=t(e,"Filter");s&&r.push(`$filter=${encodeURIComponent(s)}`);const n=t(e,"Select");n&&r.push(`$select=${encodeURIComponent(n)}`);const i=t(e,"OrderBy");i&&r.push(`$orderby=${encodeURIComponent(i)}`);const o=a(e,"Top");null!==o&&r.push(`$top=${o}`);const u=a(e,"Skip");return null!==u&&r.push(`$skip=${u}`),r.push("$count=true"),r.length>0?`?${r.join("&")}`:""}function i(e,t,a){const r=new XMLHttpRequest,s=function(e,t,a=0){const r=e[t];if(null==r||""===r)return a;const s=Number(r);return isNaN(s)?a:s}(t,"Timeout",3e4);r.onreadystatechange=function(){if(4===r.readyState)if(r.status>=200&&r.status<300)try{const e=JSON.parse(r.responseText);a(null,e,r.status)}catch(e){a(new Error(`Failed to parse JSON response: ${e}`),null,r.status)}else if(0===r.status)a(new Error("Network error or CORS issue - request failed to complete"),null,0);else{let e=`HTTP ${r.status}: ${r.statusText}`;try{const t=JSON.parse(r.responseText);t.error&&t.error.message&&(e=t.error.message)}catch{}a(new Error(e),null,r.status)}},r.ontimeout=function(){a(new Error(`Request timed out after ${s}ms`),null,0)},r.open("GET",e),r.timeout=s,r.setRequestHeader("Accept","application/json"),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("OData-Version","4.0"),r.setRequestHeader("OData-MaxVersion","4.0"),r.withCredentials=!0,r.send()}metadata={systemName:"K2ODataSmartObjectBroker",displayName:"K2 OData SmartObject Query Broker",description:"Dynamically query K2 SmartObjects via OData v4 API with support for filtering, aggregation, and grouping.",configuration:{BaseUrl:{displayName:"K2 OData Base URL",type:"string",required:!0,value:"https://k2amer.safalo.com/api/odatav4/v4"},Timeout:{displayName:"Request Timeout (ms)",type:"number",required:!1,value:"30000"}}},ondescribe=async function({configuration:e}){postSchema({objects:{DynamicQuery:{displayName:"Dynamic Query",description:"Execute dynamic OData v4 queries against any K2 SmartObject",properties:{SmartObjectName:{displayName:"SmartObject Name",type:"string"},Filter:{displayName:"OData Filter",type:"string"},Select:{displayName:"Select Fields",type:"string"},OrderBy:{displayName:"Order By",type:"string"},Top:{displayName:"Top (Limit)",type:"number"},Skip:{displayName:"Skip (Offset)",type:"number"},ResultJson:{displayName:"Result JSON",type:"string"},RecordCount:{displayName:"Record Count",type:"number"},RawResponse:{displayName:"Raw Response",type:"string"}},methods:{ExecuteQuery:{displayName:"Execute Query",type:"read",inputs:["SmartObjectName","Filter","Select","OrderBy","Top","Skip"],requiredInputs:["SmartObjectName"],outputs:["SmartObjectName","ResultJson","RecordCount","RawResponse"]},ExecuteQueryList:{displayName:"Execute Query (Return List)",type:"list",inputs:["SmartObjectName","Filter","Select","OrderBy","Top","Skip"],requiredInputs:["SmartObjectName"],outputs:["ResultJson"]}}},Aggregation:{displayName:"Aggregation",description:"Perform OData v4 aggregations (count, sum, avg, min, max) on SmartObject data",properties:{SmartObjectName:{displayName:"SmartObject Name",type:"string"},Filter:{displayName:"Pre-Aggregation Filter",type:"string"},AggregateField:{displayName:"Field to Aggregate",type:"string"},AggregateFunction:{displayName:"Aggregate Function",type:"string"},GroupByFields:{displayName:"Group By Fields",type:"string"},AggregateAlias:{displayName:"Result Alias",type:"string"},ResultJson:{displayName:"Result JSON",type:"string"},AggregateValue:{displayName:"Aggregate Value",type:"decimal"},CountValue:{displayName:"Count Value",type:"number"}},methods:{Count:{displayName:"Count Records",type:"read",inputs:["SmartObjectName","Filter"],requiredInputs:["SmartObjectName"],outputs:["SmartObjectName","CountValue","ResultJson"]},Sum:{displayName:"Sum Field",type:"read",inputs:["SmartObjectName","AggregateField","Filter","AggregateAlias"],requiredInputs:["SmartObjectName","AggregateField"],outputs:["SmartObjectName","AggregateField","AggregateValue","ResultJson"]},Average:{displayName:"Average Field",type:"read",inputs:["SmartObjectName","AggregateField","Filter","AggregateAlias"],requiredInputs:["SmartObjectName","AggregateField"],outputs:["SmartObjectName","AggregateField","AggregateValue","ResultJson"]},Min:{displayName:"Minimum Value",type:"read",inputs:["SmartObjectName","AggregateField","Filter","AggregateAlias"],requiredInputs:["SmartObjectName","AggregateField"],outputs:["SmartObjectName","AggregateField","AggregateValue","ResultJson"]},Max:{displayName:"Maximum Value",type:"read",inputs:["SmartObjectName","AggregateField","Filter","AggregateAlias"],requiredInputs:["SmartObjectName","AggregateField"],outputs:["SmartObjectName","AggregateField","AggregateValue","ResultJson"]},GroupByAggregate:{displayName:"Group By with Aggregation",type:"list",inputs:["SmartObjectName","GroupByFields","AggregateField","AggregateFunction","Filter","AggregateAlias"],requiredInputs:["SmartObjectName","GroupByFields"],outputs:["ResultJson"]}}},Metadata:{displayName:"Metadata",description:"Discover available SmartObjects and their schema via OData $metadata",properties:{SmartObjectName:{displayName:"SmartObject Name",type:"string"},MetadataJson:{displayName:"Metadata JSON",type:"string"},EntitySetList:{displayName:"Available Entity Sets",type:"string"}},methods:{GetEntitySets:{displayName:"Get Available SmartObjects",type:"read",inputs:[],outputs:["EntitySetList","MetadataJson"]},GetMetadata:{displayName:"Get Full Metadata",type:"read",inputs:[],outputs:["MetadataJson"]}}},RawQuery:{displayName:"Raw OData Query",description:"Execute custom OData v4 query strings for advanced scenarios",properties:{EntitySet:{displayName:"Entity Set / SmartObject",type:"string"},QueryString:{displayName:"OData Query String",type:"string"},ApplyClause:{displayName:"Apply Clause",type:"string"},ResultJson:{displayName:"Result JSON",type:"string"},StatusCode:{displayName:"HTTP Status Code",type:"number"},ErrorMessage:{displayName:"Error Message",type:"string"}},methods:{Execute:{displayName:"Execute Raw Query",type:"read",inputs:["EntitySet","QueryString"],requiredInputs:["EntitySet"],outputs:["EntitySet","ResultJson","StatusCode","ErrorMessage"]},ExecuteWithApply:{displayName:"Execute with $apply",type:"read",inputs:["EntitySet","ApplyClause","QueryString"],requiredInputs:["EntitySet","ApplyClause"],outputs:["EntitySet","ResultJson","StatusCode","ErrorMessage"]}}}}})},onexecute=async function({objectName:a,methodName:o,parameters:u,properties:l,configuration:p,schema:c}){switch(a){case"DynamicQuery":await async function(t,a,r){switch(t){case"ExecuteQuery":await function(t,a){return new Promise(((r,o)=>{const u=s(e(a,"BaseUrl")),l=e(t,"SmartObjectName");if(!l)return void o(new Error("SmartObjectName is required."));const p=n(t);i(`${u}/${encodeURIComponent(l)}${p}`,a,((e,t,a)=>{if(e)o(e);else try{const e=t.value||t,a=Array.isArray(e)?e.length:t["@odata.count"]||1;postResult({SmartObjectName:l,ResultJson:JSON.stringify(e),RecordCount:a,RawResponse:JSON.stringify(t)}),r()}catch(e){o(new Error(`Failed to process response: ${e}`))}}))}))}(a,r);break;case"ExecuteQueryList":await function(t,a){return new Promise(((r,o)=>{const u=s(e(a,"BaseUrl")),l=e(t,"SmartObjectName");if(!l)return void o(new Error("SmartObjectName is required."));const p=n(t);i(`${u}/${encodeURIComponent(l)}${p}`,a,((e,t,a)=>{if(e)o(e);else try{const e=(t.value||[t]).map((e=>({ResultJson:JSON.stringify(e)})));postResult(e),r()}catch(e){o(new Error(`Failed to process response: ${e}`))}}))}))}(a,r);break;default:throw new Error(`Method "${t}" is not supported for DynamicQuery.`)}}(o,l,p);break;case"Aggregation":await async function(a,n,o){switch(a){case"Count":await function(a,r){return new Promise(((n,o)=>{const u=s(e(r,"BaseUrl")),l=e(a,"SmartObjectName"),p=t(a,"Filter");if(!l)return void o(new Error("SmartObjectName is required."));let c=`${u}/${encodeURIComponent(l)}?$count=true&$top=0`;p&&(c+=`&$filter=${encodeURIComponent(p)}`),i(c,r,((e,t,a)=>{if(e)o(e);else try{const e=t["@odata.count"]||(t.value?t.value.length:0);postResult({SmartObjectName:l,CountValue:e,ResultJson:JSON.stringify({count:e})}),n()}catch(e){o(new Error(`Failed to process count response: ${e}`))}}))}))}(n,o);break;case"Sum":await r(n,o,"sum");break;case"Average":await r(n,o,"average");break;case"Min":await r(n,o,"min");break;case"Max":await r(n,o,"max");break;case"GroupByAggregate":await function(a,r){return new Promise(((n,o)=>{const u=s(e(r,"BaseUrl")),l=e(a,"SmartObjectName"),p=e(a,"GroupByFields"),c=t(a,"AggregateField"),g=e(a,"AggregateFunction")||"count",m=t(a,"Filter"),d=e(a,"AggregateAlias")||"aggregateResult";if(!l||!p)return void o(new Error("SmartObjectName and GroupByFields are required."));let y="";y=c?`,aggregate(${c} with ${g} as ${d})`:`,aggregate($count as ${d})`;const S=`groupby((${p})${y})`;let N=`${u}/${encodeURIComponent(l)}?$apply=`;m&&(N+=`filter(${encodeURIComponent(m)})/`),N+=encodeURIComponent(S),i(N,r,((e,t,a)=>{if(e)o(e);else try{const e=(t.value||[t]).map((e=>({ResultJson:JSON.stringify(e)})));postResult(e),n()}catch(e){o(new Error(`Failed to process groupby response: ${e}`))}}))}))}(n,o);break;default:throw new Error(`Method "${a}" is not supported for Aggregation.`)}}(o,l,p);break;case"Metadata":await async function(t,a,r){switch(t){case"GetEntitySets":await function(t){return new Promise(((a,r)=>{i(s(e(t,"BaseUrl")),t,((e,t,s)=>{if(e)r(e);else try{const e=t.value||[],r=e.map((e=>e.name||e.url)).join(", ");postResult({EntitySetList:r,MetadataJson:JSON.stringify(e)}),a()}catch(e){r(new Error(`Failed to process entity sets: ${e}`))}}))}))}(r);break;case"GetMetadata":await function(t){return new Promise(((a,r)=>{const n=`${s(e(t,"BaseUrl"))}/$metadata`,i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&(i.status>=200&&i.status<300?(postResult({MetadataJson:i.responseText}),a()):r(new Error(`Failed to fetch metadata: ${i.status} - ${i.statusText}`)))},i.open("GET",n),i.setRequestHeader("Accept","application/xml"),i.withCredentials=!0,i.send()}))}(r);break;default:throw new Error(`Method "${t}" is not supported for Metadata.`)}}(o,0,p);break;case"RawQuery":await async function(t,a,r){switch(t){case"Execute":await function(t,a){return new Promise(((r,n)=>{const o=s(e(a,"BaseUrl")),u=e(t,"EntitySet"),l=e(t,"QueryString");if(!u)return void n(new Error("EntitySet is required."));const p=l.startsWith("?")?"":l?"?":"";i(`${o}/${encodeURIComponent(u)}${p}${l}`,a,((e,t,a)=>{if(e)return postResult({EntitySet:u,ResultJson:"",StatusCode:a||500,ErrorMessage:e.message}),void r();postResult({EntitySet:u,ResultJson:JSON.stringify(t),StatusCode:a,ErrorMessage:""}),r()}))}))}(a,r);break;case"ExecuteWithApply":await function(t,a){return new Promise(((r,n)=>{const o=s(e(a,"BaseUrl")),u=e(t,"EntitySet"),l=e(t,"ApplyClause"),p=e(t,"QueryString");if(!u||!l)return void n(new Error("EntitySet and ApplyClause are required."));let c=`${o}/${encodeURIComponent(u)}?$apply=${encodeURIComponent(l)}`;p&&(c+=`&${p.replace(/^\?/,"")}`),i(c,a,((e,t,a)=>{if(e)return postResult({EntitySet:u,ResultJson:"",StatusCode:a||500,ErrorMessage:e.message}),void r();postResult({EntitySet:u,ResultJson:JSON.stringify(t),StatusCode:a,ErrorMessage:""}),r()}))}))}(a,r);break;default:throw new Error(`Method "${t}" is not supported for RawQuery.`)}}(o,l,p);break;default:throw new Error(`The object "${a}" is not supported.`)}};
